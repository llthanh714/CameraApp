@page "/camera"
@page "/"
@rendermode InteractiveServer
@inject IJSRuntime JSRuntime

<PageTitle>Gemini Cam</PageTitle>

<div class="container-fluid h-100 d-flex flex-column p-4 fade-in">
    <!-- Header Area -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div class="d-flex align-items-center gap-3">
            <div class="bg-primary bg-gradient rounded-circle d-flex align-items-center justify-content-center text-white" style="width: 48px; height: 48px;">
                <i class="bi bi-camera-reels-fill fs-4"></i>
            </div>
            <div>
                <h3 class="fw-bold mb-0">Gemini Cam</h3>
                <small class="text-muted">Studio thông minh</small>
            </div>
        </div>

        <div class="d-flex gap-2">
            <button class="btn-icon" @onclick="ToggleTheme" title="Chế độ Sáng/Tối">
                @if (isDarkMode)
                {
                    <i class="bi bi-moon-stars-fill text-warning"></i>
                }
                else
                {

                    <i class="bi bi-sun-fill text-warning"></i>
                }
            </button>
        </div>
    </div>

    <!-- Controls Bar -->
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="control-pill">
                <i class="bi bi-webcam"></i>
                <!-- Sử dụng @onchange để bắt sự kiện thay đổi và lưu settings -->
                <select @bind="SelectedDeviceId" @bind:after="SaveConfig">
                    @if (videoDevices == null || !videoDevices.Any())
                    {
                        <option>Đang tìm thiết bị...</option>
                    }
                    else
                    {
                        @foreach (var device in videoDevices)
                        {
                            <option value="@device.DeviceId">@device.Label</option>
                        }
                    }
                </select>
            </div>
        </div>

        <div class="col-md-3">
            <div class="control-pill">
                <i class="bi bi-aspect-ratio"></i>
                <select @bind="SelectedResolution" @bind:after="SaveConfig">
                    <option value="0x0">Auto Res</option>
                    <option value="1280x720">HD (720p)</option>
                    <option value="1920x1080">Full HD (1080p)</option>
                    <option value="3840x2160">4K Ultra HD</option>
                </select>
            </div>
        </div>

        <div class="col-md-3">
            <div class="control-pill">
                <i class="bi bi-speedometer2"></i>
                <select @bind="SelectedFps" @bind:after="SaveConfig">
                    <option value="0">Auto FPS</option>
                    <option value="30">30 FPS</option>
                    <option value="60">60 FPS</option>
                </select>
            </div>
        </div>

        <div class="col-md-3">
            @if (!isCameraRunning)
            {
                <button class="btn-gemini w-100" @onclick="StartCamera">
                    <i class="bi bi-power"></i> Khởi động Camera
                </button>
            }
            else
            {
                <button class="btn-gemini w-100 bg-secondary bg-gradient text-white" style="background: #444746;" @onclick="StopCamera">
                    <i class="bi bi-stop-circle"></i> Tắt Camera
                </button>
            }
        </div>
    </div>

    <!-- Workspace Area -->
    <div class="row flex-grow-1 g-4 overflow-hidden">
        <!-- Video Feed: Thêm class rounded-box để bo góc chuẩn -->
        <div class="col-lg-8 h-100">
            <div class="h-100 w-100 position-relative rounded-box" style="background-color: #000;">
                <video id="videoFeed" class="w-100 h-100 object-fit-cover" autoplay playsinline muted></video>

                @if (!isCameraRunning)
                {
                    <div class="position-absolute top-50 start-50 translate-middle text-center text-muted opacity-50">
                        <i class="bi bi-camera-video-off display-1"></i>
                        <p class="mt-2">Camera đang tắt</p>
                    </div>
                }

                @if (isCameraRunning)
                {
                    <div class="position-absolute bottom-0 start-0 w-100 p-4 d-flex justify-content-center gap-4"
                         style="background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);">

                        <button class="btn btn-light rounded-circle p-0 d-flex align-items-center justify-content-center shadow-lg transition-transform"
                                style="width: 64px; height: 64px;"
                                @onclick="CaptureFrame" title="Chụp ảnh">
                            <i class="bi bi-camera-fill fs-3 text-dark"></i>
                        </button>

                        <button class="btn @(isRecording ? "btn-danger" : "btn-light") rounded-circle p-0 d-flex align-items-center justify-content-center shadow-lg transition-transform position-relative"
                                style="width: 64px; height: 64px;"
                                @onclick="ToggleRecording" title="@(isRecording ? "Dừng ghi" : "Ghi hình")">
                            @if (isRecording)
                            {
                                <div class="spinner-grow spinner-grow-sm position-absolute" role="status" style="width: 100%; height: 100%; opacity: 0.3;"></div>
                                <i class="bi bi-stop-fill fs-3"></i>
                            }
                            else
                            {
                                <i class="bi bi-record-circle fs-3 text-danger"></i>
                            }
                        </button>
                    </div>

                    @if (isRecording)
                    {
                        <div class="position-absolute top-0 end-0 m-4 px-3 py-1 rounded-pill bg-danger text-white d-flex align-items-center gap-2 small fw-bold shadow">
                            <i class="bi bi-record-fill animate-pulse"></i> REC
                        </div>
                    }
                }
            </div>
        </div>

        <!-- Gallery Sidebar: Thêm class rounded-box -->
        <div class="col-lg-4 h-100 d-flex flex-column">
            <div class="bg-surface rounded-box h-100 p-3 d-flex flex-column" style="background-color: var(--bg-surface);">
                <h5 class="mb-3 fw-bold ps-2">Thư viện</h5>

                <div class="flex-grow-1 overflow-auto pe-2 custom-scrollbar">
                    @if (string.IsNullOrEmpty(capturedImage) && string.IsNullOrEmpty(recordedVideoUrl))
                    {
                        <div class="h-100 d-flex flex-column justify-content-center align-items-center text-muted opacity-25">
                            <i class="bi bi-images display-4 mb-3"></i>
                            <span>Trống</span>
                        </div>
                    }
                    else
                    {
                        <div class="d-flex flex-column gap-3">
                            @if (!string.IsNullOrEmpty(capturedImage))
                            {
                                <div class="card border-0 bg-transparent">
                                    <div class="position-relative">
                                        <img src="@capturedImage" class="w-100 rounded-3 shadow-sm border border-light border-opacity-10" />
                                        <div class="position-absolute top-0 end-0 m-2">
                                            <a href="@capturedImage" download="snapshot.png" class="btn btn-sm btn-dark rounded-circle bg-opacity-75 border-0"><i class="bi bi-download"></i></a>
                                        </div>
                                    </div>
                                    <small class="text-muted mt-1 ms-1"><i class="bi bi-image"></i> Ảnh chụp mới nhất</small>
                                </div>
                            }

                            @if (!string.IsNullOrEmpty(recordedVideoUrl))
                            {
                                <div class="card border-0 bg-transparent">
                                    <div class="position-relative">
                                        <video src="@recordedVideoUrl" controls class="w-100 rounded-3 shadow-sm border border-light border-opacity-10"></video>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center mt-1 ms-1">
                                        <small class="text-muted"><i class="bi bi-film"></i> Video mới nhất</small>
                                        <a href="@recordedVideoUrl" download="video.webm" class="text-decoration-none small fw-bold text-primary">Tải về</a>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .transition-transform:active {
        transform: scale(0.95);
    }

    .animate-pulse {
        animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }

    @@keyframes pulse {
        0%, 100% {
            opacity: 1;
        }

        50% {
            opacity: 0.5;
        }
    }

    .object-fit-cover {
        object-fit: cover;
    }
</style>

@code {
    private IJSObjectReference? module;
    private string? capturedImage;
    private string? recordedVideoUrl;

    private bool isCameraRunning = false;
    private bool isRecording = false;
    private bool isDarkMode = true;

    private List<VideoDevice> videoDevices = new();

    // Properties để binding dữ liệu
    public string SelectedDeviceId { get; set; } = "";
    public string SelectedResolution { get; set; } = "0x0";
    public int SelectedFps { get; set; } = 0;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            module = await JSRuntime.InvokeAsync<IJSObjectReference>("import", "./camera.js");

            // 1. Tải Theme
            var savedTheme = await module.InvokeAsync<string>("getSavedTheme");
            isDarkMode = savedTheme == "dark";
            await ApplyTheme();

            // 2. Tải danh sách thiết bị
            await LoadVideoDevices();

            // 3. Khôi phục cấu hình đã lưu
            await LoadConfig();

            StateHasChanged();
        }
    }

    private async Task ToggleTheme()
    {
        isDarkMode = !isDarkMode;
        await ApplyTheme();
    }

    private async Task ApplyTheme()
    {
        if (module is not null) await module.InvokeVoidAsync("setTheme", isDarkMode ? "dark" : "light");
    }

    // --- Logic Cấu hình ---
    private async Task LoadConfig()
    {
        if (module is not null)
        {
            var savedSettings = await module.InvokeAsync<CameraSettings?>("getSavedSettings");
            if (savedSettings != null)
            {
                // Chỉ set device ID nếu nó còn tồn tại trong list hiện tại
                if (videoDevices.Any(d => d.DeviceId == savedSettings.DeviceId))
                {
                    SelectedDeviceId = savedSettings.DeviceId;
                }
                SelectedResolution = savedSettings.Resolution;
                SelectedFps = savedSettings.Fps;
            }
        }
    }

    private async Task SaveConfig()
    {
        if (module is not null)
        {
            var settings = new CameraSettings
            {
                DeviceId = SelectedDeviceId,
                Resolution = SelectedResolution,
                Fps = SelectedFps
            };
            await module.InvokeVoidAsync("saveSettings", settings);

            // Nếu camera đang chạy, restart để áp dụng ngay
            if (isCameraRunning)
            {
                await StartCamera();
            }
        }
    }

    // --- Logic Camera ---
    private async Task LoadVideoDevices()
    {
        if (module is not null)
        {
            var devices = await module.InvokeAsync<VideoDevice[]>("getVideoDevices");
            videoDevices = devices.ToList();

            // Mặc định chọn cái đầu tiên nếu chưa có cái nào được chọn
            if (videoDevices.Any() && string.IsNullOrEmpty(SelectedDeviceId))
                SelectedDeviceId = videoDevices.First().DeviceId;
        }
    }

    private async Task StartCamera()
    {
        if (module is not null)
        {
            int width = 0; int height = 0;
            if (SelectedResolution != "0x0")
            {
                var parts = SelectedResolution.Split('x');
                if (parts.Length == 2) { int.TryParse(parts[0], out width); int.TryParse(parts[1], out height); }
            }
            await module.InvokeVoidAsync("startCamera", "videoFeed", SelectedDeviceId, width, height, SelectedFps);
            isCameraRunning = true;
            capturedImage = null;
            recordedVideoUrl = null;
        }
    }

    private async Task StopCamera()
    {
        if (module is not null)
        {
            if (isRecording) await StopRecording();
            await module.InvokeVoidAsync("stopCamera", "videoFeed");
            isCameraRunning = false;
        }
    }

    private async Task CaptureFrame()
    {
        if (module is not null) capturedImage = await module.InvokeAsync<string>("takePicture", "videoFeed");
    }

    private async Task ToggleRecording() { if (isRecording) await StopRecording(); else await StartRecording(); }

    private async Task StartRecording()
    {
        if (module is not null) { if (await module.InvokeAsync<bool>("startRecording", "videoFeed")) { isRecording = true; recordedVideoUrl = null; } }
    }

    private async Task StopRecording()
    {
        if (module is not null) { recordedVideoUrl = await module.InvokeAsync<string>("stopRecording"); isRecording = false; }
    }

    public class VideoDevice { public string DeviceId { get; set; } = ""; public string Label { get; set; } = ""; }

    // Class DTO để lưu cấu hình
    public class CameraSettings
    {
        public string DeviceId { get; set; } = "";
        public string Resolution { get; set; } = "0x0";
        public int Fps { get; set; } = 0;
    }
}